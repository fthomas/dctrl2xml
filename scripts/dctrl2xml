#!/usr/bin/python2.3
# $Id$
#
# dctrl2xml
# Copyright (C) 2005 by Frank S. Thomas <frank@thomas-alfeld.de>
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License 
# along with this program; if not, write to the
# Free Software Foundation, Inc.,
# 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.

import sys
import re
import gzip
import bz2

from optparse import OptionParser
from xml.dom import minidom, Document, Node
from xml.dom.ext import PrettyPrint

def main():
    opts = parse_options()
    packages = read_packages(opts.filename)

    doc  = minidom.parseString('<packages/>')
    root = doc.documentElement
    
    for pkg_text in packages:
        append_package_node(doc, root, pkg_text)

    PrettyPrint(doc)
    return
    
def append_package_node(doc, root, pkg_text):
    if pkg_text.strip() == '':
        return
        
    parse_package(pkg_text)
    
def parse_package(pkg_text):
    parsed_pkg = {}
    it = re.compile(r'^([\w-]*): (.*)', re.M).finditer(pkg_text)
    for match in it:
        parsed_pkg[match.group(1)] = match.group(2)
    
    """ parse files """
    if parsed_pkg.has_key('Files'):
        parsed_pkg['Files'] = parse_package_source_files(pkg_text)
    
    """ parse maintainer """
    if parsed_pkg.has_key('Maintainer'):
        match = re.compile(r'(.*) <(.*)>').search(parsed_pkg['Maintainer'])
        if match:
            parsed_pkg['Maintainer'] = {'Name': match.group(1),
                                        'Email': match.group(2)}
                                        
    """ parse package relationships """
    rel = ['Depends', 'Pre-Depends', 'Suggests', 'Recommends', 'Conflicts',
           'Provides', 'Replaces', 'Enhances', 'Build-Depends',
           'Build-Depends-Indep', 'Build-Conflicts']
    for field in parsed_pkg.iterkeys():
        if field in rel:
            parsed_pkg[field] = parse_package_relations(parsed_pkg[field])
    
    return parsed_pkg
    
def parse_package_relations(relations_text):
    relations = relations_text.split(',')
    relations_list = []
    
    for relation in relations:
        if re.search('\|', relation):
            alternatives = relation.split('|')
            alternatives_list = []
            for alternative in alternatives:
                alternatives_list.append(parse_relation(alternative))
            relations_list.append({'Alternative': alternatives_list})
        else:
            relations_list.append(parse_relation(relation))

def parse_relation(relation):
    relation = relation.strip()
    relation_re = r'([\w\+\-\.]*) ?(\(([<>=]{2}) (.*)\))? ?(\[(.*)\])?'
    relation_pkg = {}
    
    match = re.match(relation_re, relation)
    if match:
        if match.group(1):
            relation_pkg['Package'] = match.group(1)
        if match.group(2):
            relation_pkg['Relation'] = match.group(3)
            relation_pkg['Version'] = match.group(4)
    
    print relation_pkg    

def parse_package_source_files(pkg_text):
    files = {'DSC':{}, 'Diff':{}, 'Orig':{}}
    files_re = {'DSC': '.*\.dsc', 'Diff': '.*\.diff\.gz',
                'Orig': '.*\.orig\.tar\.gz'}
    
    it = re.compile(r' ([0-9a-f]{32}.*)').finditer(pkg_text)
    for file_line in it:
        if file_line.group(1):
            attrs = file_line.group(1).split(' ')
            for file_type, file_re in files_re.iteritems():                
                if re.search(file_re, attrs[2]):
                    files[file_type]['MD5sum'] = attrs[0]
                    files[file_type]['Size'] = attrs[1]
                    files[file_type]['Filename'] = attrs[2]
    return files
    
def read_packages(filename):
    if not filename:
        packages = sys.stdin.read()
    else:
        packages = read_packages_from_file(filename)

    packages = re.compile('^\n', re.M).split(packages)
    return packages
    
def read_packages_from_file(filename):
    extension = filename.split('.')[-1]

    if extension == 'gz':
        file_obj = gzip.GzipFile
    elif extension == 'bz2':
        file_obj = bz2.BZ2File
    else:
        file_obj = file

    try:
        content = file_obj(filename, 'r').read()
    except IOError, error:
        print error
        sys.exit(error.args[0]);
    
    return content
    
def parse_options():
    parser = OptionParser()
    parser.add_option('-f', '--file', dest='filename', default='',
                      metavar='FILE')
    (opts, args) = parser.parse_args()
    return opts
    
if __name__ == '__main__':
    main()
